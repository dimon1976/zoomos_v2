<!-- src/main/resources/templates/files/status.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Статус обработки файла</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <div th:replace="~{fragments/navbar :: header-css}"></div>
</head>
<body>
<div th:replace="~{fragments/navbar :: header}"></div>
<div class="container mt-4">
    <!-- Навигация -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb" class="d-flex align-items-center">
                <a th:href="@{/}" class="btn btn-sm btn-outline-secondary me-2" title="На главную">
                    <i class="fas fa-home"></i>
                </a>
                <a th:href="@{/clients}" class="btn btn-sm btn-outline-secondary me-2" title="К списку магазинов">
                    <i class="fas fa-store"></i>
                </a>
                <a th:href="@{/client/{id}/dashboard(id=${clientId})}"
                   class="btn btn-sm btn-outline-secondary me-2" title="К панели управления">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a th:href="@{/clients}">Магазины</a></li>
                    <li class="breadcrumb-item">
                        <a th:href="@{/client/{id}/dashboard(id=${clientId})}">Панель управления</a>
                    </li>
                    <li class="breadcrumb-item active">Статус обработки файла</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title h5 mb-0">
                        <i class="fas fa-tasks me-2"></i>Статус обработки файла
                    </h2>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h5><i class="fas fa-info-circle me-2"></i>Информация о файле</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <tbody>
                                <tr>
                                    <th style="width: 30%">Имя файла</th>
                                    <td th:text="${file.originalFilename}"></td>
                                </tr>
                                <tr>
                                    <th>Тип файла</th>
                                    <td th:text="${file.fileType}"></td>
                                </tr>
                                <tr>
                                    <th>Статус</th>
                                    <td>
                                        <span th:with="statusClass=${
                                            file.status.name() == 'PENDING' ? 'bg-secondary' :
                                            file.status.name() == 'IN_PROGRESS' ? 'bg-primary' :
                                            file.status.name() == 'COMPLETED' ? 'bg-success' :
                                            file.status.name() == 'FAILED' ? 'bg-danger' :
                                            file.status.name() == 'CANCELLED' ? 'bg-secondary' :
                                            file.status.name() == 'PARTIAL_SUCCESS' ? 'bg-warning' : 'bg-secondary'
                                        }"
                                              th:class="${'badge ' + statusClass}"
                                              th:text="${file.status}">
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Загружен</th>
                                    <td th:text="${#temporals.format(file.uploadedAt, 'dd.MM.yyyy HH:mm')}"></td>
                                </tr>
                                <tr class="statistics-row">
                                    <th>Обработано записей</th>
                                    <td>
        <span class="processed-records"
              th:text="${operation.processedRecords != null ?
                      operation.processedRecords + ' из ' + operation.totalRecords : '0 из 0'}">
        </span>
                                    </td>
                                </tr>
                                <tr class="statistics-row">
                                    <th>Скорость обработки</th>
                                    <td>
        <span class="processing-speed"
              th:text="${operation.processingSpeed != null ?
                      #numbers.formatDecimal(operation.processingSpeed, 1, 2) + ' записей/сек' :
                      '0 записей/сек'}">
        </span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Прогресс обработки -->
                    <div class="mb-4">
                        <h5>
                            <i class="fas fa-spinner me-2" id="progress-spinner"></i>Прогресс обработки
                        </h5>
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 th:style="'width: ' + ${currentProgress.get('currentProgress') ?: 0} + '%'"
                                 th:attr="aria-valuenow=${currentProgress.get('currentProgress') ?: 0}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <span th:text="${currentProgress.get('currentProgress') ?: 0} + '%'"></span>
                            </div>
                        </div>
                        <!-- Статус обработки отдельно -->
                        <div class="alert alert-info mt-2" th:with="message=${currentProgress.get('message')}">
                            <i class="fas fa-info-circle me-1"></i>
                            <span th:text="${message ?: 'Инициализация...'}"></span>
                        </div>
                    </div>

                    <!-- Кнопки действий -->
                    <div class="d-flex gap-2 justify-content-end">
                        <a th:href="@{/client/{id}/dashboard(id=${clientId})}"
                           class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>К панели управления
                        </a>

                        <button class="btn btn-warning cancel-button"
                                onclick="cancelProcessing()"
                                style="display: none;">
                            <i class="fas fa-stop-circle me-2"></i>Отменить обработку
                        </button>

                        <a th:href="@{/client/{id}/files/{fileId}/statistics(id=${clientId},fileId=${file.id})}"
                           class="btn btn-primary view-results-button"
                           style="display: none;">
                            <i class="fas fa-chart-bar me-2"></i>Просмотр результатов
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{fragments/navbar :: footer}"></div>

<script th:inline="javascript">
    const fileStatus = /*[[${file.status}]]*/ 'PENDING';
    const fileId = /*[[${file.id}]]*/ '';
    const clientId = /*[[${clientId}]]*/ '';
    let updateInterval;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;

    function cancelProcessing() {
        if (confirm('Вы уверены, что хотите отменить обработку файла?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/client/${clientId}/files/status/${fileId}/cancel`;

            // Добавляем CSRF токен если он есть
            const csrfElement = document.querySelector('meta[name="_csrf"]');
            if (csrfElement) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfElement.content;
                form.appendChild(csrfInput);
            }

            document.body.appendChild(form);
            form.submit();
        }
    }

    // Вспомогательные функции (вынесены на верхний уровень)
    function updateButtons(status) {
        const cancelButton = document.querySelector('.cancel-button');
        const viewResultsButton = document.querySelector('.view-results-button');

        if (cancelButton) {
            console.log('Current status:', status); // Для отладки
            cancelButton.style.display = status === 'IN_PROGRESS' ? 'inline-block' : 'none';
        }

        if (viewResultsButton) {
            viewResultsButton.style.display = status === 'COMPLETED' ? 'inline-block' : 'none';
        }
    }

    function initStatusUpdate() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }

        fetchStatus(); // Первичный запрос статуса

        // Устанавливаем интервал только если статус позволяет
        const status = /*[[${file.status}]]*/ 'PENDING';
        if (['PENDING', 'IN_PROGRESS'].includes(status)) {
            updateInterval = setInterval(fetchStatus, 2000);
        }
    }

    function updateUI(data) {
        const progressBar = document.querySelector('.progress-bar');
        const progressSpinner = document.getElementById('progress-spinner');
        const statusMessage = document.querySelector('.alert.alert-info span');
        const statusBadge = document.querySelector('.badge');
        const cancelButton = document.querySelector('.cancel-button');
        const viewResultsButton = document.querySelector('.view-results-button');

        // Обновляем прогресс-бар
        if (progressBar) {
            const progress = Math.min(data.progress || 0, 100);
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.querySelector('span').textContent = `${progress}%`;

            // Обновляем стиль прогресс-бара в зависимости от статуса
            if (['COMPLETED', 'FAILED', 'CANCELLED'].includes(data.status)) {
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                progressSpinner.classList.remove('fa-spin');

                switch (data.status) {
                    case 'COMPLETED':
                        progressBar.classList.add('bg-success');
                        break;
                    case 'FAILED':
                        progressBar.classList.add('bg-danger');
                        break;
                    case 'CANCELLED':
                        progressBar.classList.add('bg-warning');
                        break;
                }
            } else {
                progressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
                progressSpinner.classList.add('fa-spin');
            }
        }

        // Обновляем сообщение
        if (statusMessage && data.message) {
            statusMessage.textContent = data.message;
        }

        // Обновляем бейдж статуса
        if (statusBadge && data.status) {
            statusBadge.textContent = data.status;
            const statusClass = getStatusClass(data.status);
            updateStatusClass(statusBadge, statusClass);
        }

        // Обновляем отображение кнопок
        if (cancelButton) {
            cancelButton.style.display = data.status === 'IN_PROGRESS' ? 'inline-block' : 'none';
        }

        if (viewResultsButton) {
            viewResultsButton.style.display = data.status === 'COMPLETED' ? 'inline-block' : 'none';
        }

        updateProcessingStats(data);
    }


    function getStatusClass(status) {
        const statusClasses = {
            'PENDING': 'bg-secondary',
            'IN_PROGRESS': 'bg-primary',
            'COMPLETED': 'bg-success',
            'FAILED': 'bg-danger',
            'CANCELLED': 'bg-secondary',
            'PARTIAL_SUCCESS': 'bg-warning'
        };
        return statusClasses[status] || 'bg-secondary';
    }

    function updateStatusClass(element, newClass) {
        const classes = ['bg-secondary', 'bg-primary', 'bg-success', 'bg-danger', 'bg-warning'];
        classes.forEach(cls => element.classList.remove(cls));
        element.classList.add(newClass);
    }

    async function fetchStatus() {
        try {
            const response = await fetch(
                `/api/client/${clientId}/files/${fileId}/status?t=${Date.now()}`,
                {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                }
            );

            if (!response.ok) {
                throw new Error(`HTTP Error ${response.status}`);
            }

            reconnectAttempts = 0;
            const data = await response.json();
            updateUI(data);

            // Обновляем интервал в зависимости от статуса
            if (['COMPLETED', 'FAILED', 'CANCELLED'].includes(data.status)) {
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }

                switch (data.status) {
                    case 'CANCELLED':
                        showWarningNotification("Обработка отменена пользователем");
                        break;
                    case 'FAILED':
                        showErrorNotification(data.message || "Ошибка обработки файла");
                        break;
                    case 'COMPLETED':
                        setTimeout(() => window.location.reload(), 1500);
                        break;
                }
            }
        } catch (error) {
            console.error('Ошибка при получении статуса:', error);
            handleFetchError(error);
        }
    }

    function updateProcessingStats(data) {
        if (data.processedRecords !== undefined && data.totalRecords !== undefined) {
            const processedEl = document.querySelector('.processed-records');
            if (processedEl) {
                processedEl.textContent = `${data.processedRecords} из ${data.totalRecords}`;
            }
        }
        if (data.processingSpeed !== undefined) {
            const speedEl = document.querySelector('.processing-speed');
            if (speedEl) {
                speedEl.textContent = `${data.processingSpeed.toFixed(2)} записей/сек`;
            }
        }
    }

    function handleFetchError(error) {
        const statusMessage = document.querySelector('.text-muted span');
        if (statusMessage) {
            statusMessage.textContent = `Ошибка соединения: ${error.message}`;
            statusMessage.style.color = '#dc3545';
        }

        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
        }

        setTimeout(initStatusUpdate, 5000); // Попытка переподключения через 5 секунд
    }

    function showErrorNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'alert alert-danger mt-3';
        notification.innerHTML = `
           <i class="fas fa-exclamation-circle me-2"></i>
           ${message}
       `;
        document.querySelector('.card-body').appendChild(notification);
    }

    function showWarningNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'alert alert-warning mt-3';
        notification.innerHTML = `
           <i class="fas fa-exclamation-triangle me-2"></i>
           ${message}
       `;
        document.querySelector('.card-body').appendChild(notification);
    }

    // При загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        const initialStatus = /*[[${file.status}]]*/ 'PENDING';
        const progressSpinner = document.getElementById('progress-spinner');

        // Применяем начальные стили
        if (!['COMPLETED', 'FAILED', 'CANCELLED'].includes(initialStatus)) {
            progressSpinner.classList.add('fa-spin');
        }

        // Всегда делаем начальный запрос
        initStatusUpdate();
    });

    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            console.log('Страница стала видимой, обновляем статус...');
            initStatusUpdate();
        } else {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }
    });

    window.addEventListener('beforeunload', () => {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
</script>
</body>
</html>